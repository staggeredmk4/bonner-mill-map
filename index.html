<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bonner Mill Site - Truck Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root { --panelW: 360px; }
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: grid; grid-template-columns: var(--panelW) 1fr; }
    #sidebar {
      padding: 12px;
      border-right: 1px solid #ddd;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      overflow: auto;
      background: #fff;
    }
    #map { height: 100%; }

    .title { font-weight: 700; font-size: 16px; margin: 0 0 6px; }
    .sub { color: #555; font-size: 12px; margin: 0 0 10px; line-height: 1.25; }
    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; }
    input[type="search"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 10px; font-size: 14px; }
    button {
      padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background: #f7f7f7;
      font-weight: 600; cursor: pointer;
    }
    button:active { transform: translateY(1px); }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; background: #fafafa; }
    .sectionTitle { font-weight: 700; margin: 12px 0 8px; }
    .list { display: grid; gap: 8px; }
    .card {
      border: 1px solid #e5e5e5; border-radius: 14px; padding: 10px;
      display: grid; gap: 4px; background: #fff;
    }
    .card .line1 { font-weight: 800; display: flex; justify-content: space-between; gap: 8px; }
    .card .line2 { color: #444; font-size: 13px; }
    .card .line3 { color: #666; font-size: 12px; }
    .card:hover { border-color: #c9c9c9; }
    .smallNote { font-size: 12px; color: #666; line-height: 1.3; }

    .arrivals { display: grid; gap: 8px; margin-top: 8px; }
    .arrivalBtn {
      width: 100%; text-align: left; padding: 10px; border-radius: 12px;
      border: 1px solid #ddd; background: #fff; font-weight: 700;
    }
    .arrivalBtn span { font-weight: 600; color: #555; }

    .coordBox {
      margin-top: 10px; padding: 10px; border-radius: 12px; background: #f7f7ff; border: 1px solid #d9d9ff;
      font-size: 12px; color: #333; line-height: 1.35;
    }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    @media (max-width: 860px) {
      #app { grid-template-columns: 1fr; grid-template-rows: 46% 54%; }
      #sidebar { border-right: none; border-bottom: 1px solid #ddd; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="sidebar">
    <div class="title">Bonner Mill Site – Truck Map</div>
    <div class="sub">
      Scan → pick a business → pick an arrival point → follow the highlighted route.
      <br><span class="pill">Addresses included for BOLs</span>
    </div>

    <div class="row">
      <button id="resetBtn" title="Return to entrance">Reset to Entrance</button>
      <button id="clearBtn" title="Clear selection">Clear</button>
    </div>

    <input id="search" type="search" placeholder="Search by business name or address (e.g., 9088 or Whitehouse)" />

    <div class="sectionTitle">Destinations</div>
    <div id="bizList" class="list"></div>

    <div id="detail" style="margin-top:12px;"></div>

    <div class="coordBox">
      <div><b>Admin helper (not for drivers):</b></div>
      <div>Tap the map to show image coordinates for placing arrival points & routes.</div>
      <div id="coordReadout" style="margin-top:6px;">Click the map…</div>
      <div class="smallNote" style="margin-top:6px;">
        Coordinates are in <b>image space</b> (not GPS). That’s intentional so we aren’t dependent on Google roads.
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
/**
 * ============================================================
 * 1) CONFIG: Set the base image file name here
 * ============================================================
 */
const BASE_IMAGE = "site.png"; // <-- change to "site.jpg" if needed

/**
 * ============================================================
 * 2) DATA: Businesses (Vacant L excluded)
 *    Arrival points & routes: you will fill coordinates later.
 * ============================================================
 * Coordinate system:
 *  - We're using Leaflet CRS.Simple on top of your site image.
 *  - Points are [y, x] where:
 *      y = distance down from top of image
 *      x = distance right from left edge
 *
 * How to get coords:
 *  - Click on the map where you want a point.
 *  - Read the [y, x] shown in the sidebar.
 */
const SITE = {
  origin: {
    id: "STAR",
    label: "YOU ARE HERE (Main Entrance / QR)",
    address: "9329 Bonner Mill Road",
    // TODO: set coords after you click the star location on the map.
    // Example: coord: [1200, 1850]
    coord: null
  },

  businesses: [
    { id:"A", name:"UFP", address:"9088A Bonner Mill Road",
      arrivals: [
        { id:"A1", label:"Arrival A1 (Ship/Recv)", coord:null, route: [] },
        { id:"A2", label:"Arrival A2 (Ship/Recv)", coord:null, route: [] },
        { id:"A3", label:"Arrival A3 (Ship/Recv)", coord:null, route: [] },
        { id:"A4", label:"Arrival A4 (Ship/Recv)", coord:null, route: [] },
        { id:"A5", label:"Arrival A5 (Ship/Recv)", coord:null, route: [] },
        { id:"A6", label:"Arrival A6 (Ship/Recv)", coord:null, route: [] },
        { id:"A7", label:"Arrival A7 (Ship/Recv)", coord:null, route: [] },
        { id:"A8", label:"Arrival A8 (Ship/Recv)", coord:null, route: [] },
      ]
    },
    { id:"B", name:"Alcom LLC", address:"9063 Bonner Mill Road",
      arrivals: [
        { id:"B1", label:"Shipping (B1)", coord:null, route: [] },
        { id:"B2", label:"Receiving (B2)", coord:null, route: [] },
      ]
    },
    { id:"C", name:"Montana Whiskey", address:"9257 Bonner Mill Road",
      arrivals: [
        { id:"C1", label:"Arrival (C1)", coord:null, route: [] },
      ]
    },
    { id:"D", name:"Big Sky Fulfillment", address:"9263 Bonner Mill Road",
      arrivals: [
        { id:"D1", label:"Shipping (D1)", coord:null, route: [] },
        { id:"D2", label:"Receiving (D2)", coord:null, route: [] },
        { id:"D3", label:"Shipping/Receiving (D3)", coord:null, route: [] },
      ]
    },
    { id:"E", name:"Posh Chocolate", address:"327 Whitehouse Lane",
      arrivals: [
        { id:"E1", label:"Arrival (E1)", coord:null, route: [] },
      ]
    },
    { id:"F", name:"Zombie Tools", address:"9165 Bonner Mill Road",
      arrivals: [
        { id:"F1", label:"Arrival (F1)", coord:null, route: [] },
      ]
    },
    { id:"G", name:"Botanie Soap", address:"8758 Bonner Mill Road",
      arrivals: [
        { id:"G1", label:"Arrival (G1)", coord:null, route: [] },
      ]
    },
    { id:"H", name:"Northwest Factory Finishes", address:"8941 Bonner Mill Road",
      arrivals: [
        { id:"H1", label:"Arrival (H1)", coord:null, route: [] },
      ]
    },
    { id:"I", name:"Planetary Designs", address:"9255 Bonner Mill Road",
      arrivals: [
        { id:"I1", label:"Arrival (I1)", coord:null, route: [] },
        { id:"I2", label:"Arrival (I2)", coord:null, route: [] },
      ]
    },
    { id:"J", name:"Zootown Volleyball", address:"9251 Bonner Mill Road",
      arrivals: [
        { id:"J1", label:"Arrival (J1)", coord:null, route: [] },
      ]
    },
    { id:"K", name:"WMA Specialist", address:"9088D Bonner Mill Road",
      arrivals: [
        { id:"K1", label:"Arrival (K1)", coord:null, route: [] },
      ]
    },
    { id:"M", name:"WCP Solutions", address:"9088B Bonner Mill Road",
      arrivals: [
        { id:"M1", label:"Arrival (M1)", coord:null, route: [] },
      ]
    },
    { id:"N", name:"NIM Norfolk Iron & Metal", address:"9144 Bonner Mill Road",
      arrivals: [
        { id:"N1", label:"Arrival (N1)", coord:null, route: [] },
      ]
    },
  ]
};

/**
 * ============================================================
 * 3) MAP SETUP: Use the image as a base map (CRS.Simple)
 * ============================================================
 */
const map = L.map("map", {
  crs: L.CRS.Simple,
  zoomControl: true,
  minZoom: -3,
  maxZoom: 3
});

// We need image dimensions to set bounds. We'll load the image to get width/height.
let imageBounds = null;
let imageOverlay = null;

const layers = {
  origin: L.layerGroup().addTo(map),
  businessMarkers: L.layerGroup().addTo(map),
  arrivalMarkers: L.layerGroup().addTo(map),
  route: L.layerGroup().addTo(map),
};

function fmtCoord(latlng) {
  // latlng in CRS.Simple is {lat: y, lng: x}
  const y = Math.round(latlng.lat);
  const x = Math.round(latlng.lng);
  return `[${y}, ${x}]`;
}

function clearSelection() {
  layers.arrivalMarkers.clearLayers();
  layers.route.clearLayers();
  setDetail(null);
}

function resetToEntrance() {
  clearSelection();
  // If origin coord set, zoom there; otherwise fit to image
  if (SITE.origin.coord && imageBounds) {
    map.setView(SITE.origin.coord, 0);
  } else if (imageBounds) {
    map.fitBounds(imageBounds);
  }
}

document.getElementById("resetBtn").addEventListener("click", resetToEntrance);
document.getElementById("clearBtn").addEventListener("click", clearSelection);

map.on("click", (e) => {
  document.getElementById("coordReadout").innerHTML =
    `Map click coordinate: <code>${fmtCoord(e.latlng)}</code> &nbsp; (y, x)`;
});

/**
 * ============================================================
 * 4) RENDER: Business list + markers
 * ============================================================
 */
function buildBusinessList(filterText = "") {
  const listEl = document.getElementById("bizList");
  listEl.innerHTML = "";

  const q = filterText.trim().toLowerCase();

  const results = SITE.businesses.filter(b => {
    const hay = `${b.id} ${b.name} ${b.address}`.toLowerCase();
    return !q || hay.includes(q);
  });

  results.forEach(b => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.cursor = "pointer";
    card.innerHTML = `
      <div class="line1">
        <div>${b.id} – ${b.name}</div>
        <div class="pill">${b.arrivals.length} point${b.arrivals.length>1?"s":""}</div>
      </div>
      <div class="line2">${b.address}</div>
      <div class="line3">Tap to choose arrival point & show route</div>
    `;
    card.addEventListener("click", () => selectBusiness(b.id));
    listEl.appendChild(card);
  });

  if (results.length === 0) {
    const empty = document.createElement("div");
    empty.className = "smallNote";
    empty.textContent = "No matches. Try a different business name or address number.";
    listEl.appendChild(empty);
  }
}

document.getElementById("search").addEventListener("input", (e) => {
  buildBusinessList(e.target.value);
});

function setDetail(html) {
  const detail = document.getElementById("detail");
  detail.innerHTML = html || "";
}

function selectBusiness(bizId) {
  const biz = SITE.businesses.find(b => b.id === bizId);
  if (!biz) return;

  // Show arrival point buttons
  let html = `
    <div class="sectionTitle">Selected: ${biz.id} – ${biz.name}</div>
    <div class="smallNote">${biz.address}</div>
    <div class="arrivals">
  `;

  biz.arrivals.forEach(a => {
    html += `
      <button class="arrivalBtn" onclick="window.__selectArrival('${biz.id}','${a.id}')">
        ${a.id} – <span>${a.label}</span>
      </button>
    `;
  });

  html += `</div>
    <div class="smallNote" style="margin-top:8px;">
      Note: arrival points and routes will appear once their coordinates are entered.
    </div>
  `;
  setDetail(html);
}

// expose to inline onclick
window.__selectArrival = (bizId, arrivalId) => {
  const biz = SITE.businesses.find(b => b.id === bizId);
  if (!biz) return;
  const ap = biz.arrivals.find(a => a.id === arrivalId);
  if (!ap) return;

  layers.arrivalMarkers.clearLayers();
  layers.route.clearLayers();

  // If coords missing, just show message.
  if (!ap.coord || ap.coord.length !== 2) {
    alert(`${arrivalId} has no coordinate yet.\n\nClick the map at the correct spot and copy the [y,x] into index.html for ${arrivalId}.`);
    return;
  }

  // Arrival marker
  const arrivalMarker = L.marker(ap.coord, { title: `${biz.id} ${biz.name} - ${ap.id}` })
    .bindPopup(`<b>${biz.id} – ${biz.name}</b><br>${biz.address}<br><b>${ap.id}</b>: ${ap.label}`)
    .addTo(layers.arrivalMarkers);

  // Route polyline (if provided)
  if (Array.isArray(ap.route) && ap.route.length >= 2) {
    L.polyline(ap.route, { weight: 8, opacity: 0.9 })
      .addTo(layers.route);
    // Fit view to route
    const bounds = L.latLngBounds(ap.route);
    map.fitBounds(bounds.pad(0.2));
  } else {
    map.setView(ap.coord, 0);
  }

  arrivalMarker.openPopup();
};

/**
 * ============================================================
 * 5) Load the base image and initialize everything
 * ============================================================
 */
function initWithImage() {
  const img = new Image();
  img.onload = () => {
    const w = img.width;
    const h = img.height;

    // bounds in CRS.Simple: [[y0,x0],[y1,x1]] => [[0,0],[h,w]]
    imageBounds = [[0,0],[h,w]];
    imageOverlay = L.imageOverlay(BASE_IMAGE, imageBounds).addTo(map);
    map.fitBounds(imageBounds);

    // Origin marker (once coord added)
    layers.origin.clearLayers();
    if (SITE.origin.coord) {
      L.circleMarker(SITE.origin.coord, { radius: 10, weight: 2 })
        .bindPopup(`<b>${SITE.origin.label}</b><br>${SITE.origin.address}`)
        .addTo(layers.origin);
    }

    // Business markers (optional: only if you add a coord per business later)
    // For now, we keep the map clean; arrival points appear after selection.

    buildBusinessList("");
  };
  img.onerror = () => {
    alert(`Could not load base image "${BASE_IMAGE}".\n\nMake sure it is in the same folder as index.html in your GitHub repo.`);
  };
  img.src = BASE_IMAGE;
}

initWithImage();
</script>
</body>
</html>
