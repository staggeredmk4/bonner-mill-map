<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bonner Mill Site - Truck Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --panelW: 360px;
      --radius: 14px;
      --border: 1px solid #e5e5e5;
    }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Desktop layout: left panel + map */
    #app {
      height: 100%;
      display: grid;
      grid-template-columns: var(--panelW) 1fr;
    }
    #sidebar {
      padding: 12px;
      border-right: 1px solid #ddd;
      overflow: auto;
      background: #fff;
      z-index: 20;
    }
    #map { height: 100%; }

    .title { font-weight: 800; font-size: 16px; margin: 0 0 6px; }
    .sub { color: #555; font-size: 12px; margin: 0 0 10px; line-height: 1.25; }

    .row { display: flex; gap: 8px; align-items: center; margin: 8px 0; flex-wrap: wrap; }
    input[type="search"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      font-weight: 700;
      cursor: pointer;
    }
    button:active { transform: translateY(1px); }

    .sectionTitle { font-weight: 800; margin: 12px 0 8px; }
    .smallNote { font-size: 12px; color: #666; line-height: 1.3; }

    .list { display: grid; gap: 8px; }

    .card {
      border: var(--border);
      border-radius: var(--radius);
      padding: 10px;
      display: grid;
      gap: 4px;
      background: #fff;
    }
    .card:hover { border-color: #c9c9c9; }
    .cardActive { border-color: #bdbdbd; box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
    .line1 { font-weight: 900; display: flex; justify-content: space-between; gap: 8px; align-items: baseline; }
    .line2 { color: #444; font-size: 13px; }
    .line3 { color: #666; font-size: 12px; }

    /* Inline arrivals inside a business card */
    .inlineArrivals {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed #e3e3e3;
      display: grid;
      gap: 8px;
    }
    .arrivalBtn {
      width: 100%;
      text-align: left;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      font-weight: 800;
    }
    .arrivalBtn span { font-weight: 700; color: #555; }

    /* Admin coordinate helper */
    .coordBox {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f7f7ff;
      border: 1px solid #d9d9ff;
      font-size: 12px;
      color: #333;
      line-height: 1.35;
    }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* MOBILE: Keep map big. Sidebar becomes a bottom drawer overlay */
    @media (max-width: 860px) {
      #app {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr; /* map owns the layout */
      }
      #sidebar {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 42%;
        max-height: 420px;
        border-right: none;
        border-top: 1px solid #ddd;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -8px 22px rgba(0,0,0,0.12);
        overflow: auto;
        padding: 12px;
      }
      #sidebar.drawer-collapsed {
        height: 64px;
        overflow: hidden;
        padding-bottom: 10px;
      }
      #drawerHandle {
        display: flex;
        justify-content: center;
        margin-bottom: 8px;
      }
      #drawerHandle .bar {
        width: 44px;
        height: 5px;
        border-radius: 999px;
        background: #d6d6d6;
      }
      #drawerToggleRow {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }
      #drawerToggleRow button {
        padding: 8px 10px;
      }
      #map { height: 100%; }
    }

    /* Desktop: hide drawer handle */
    #drawerHandle { display: none; }
    #drawerToggleRow { display: none; }
    @media (max-width: 860px) {
      #drawerHandle { display: flex; }
      #drawerToggleRow { display: flex; }
    }
  </style>
</head>

<body>
<div id="app">
  <div id="sidebar" class="drawer-collapsed">
    <div id="drawerHandle"><div class="bar"></div></div>

    <div id="drawerToggleRow">
      <div style="font-weight:900;">Destinations</div>
      <button id="drawerToggleBtn" type="button">Expand</button>
    </div>

    <div class="title">Bonner Mill Site – Truck Map</div>
    <div class="sub">
      Pick a business → pick an arrival point → follow the highlighted route.
      <br>Addresses are listed in case the BOL shows only an address.
    </div>

    <div class="row">
      <button id="resetBtn" type="button" title="Return to entrance">Reset to Entrance</button>
      <button id="clearBtn" type="button" title="Clear selection">Clear</button>
    </div>

    <input id="search" type="search" placeholder="Search by business name or address (e.g., 9088 or Whitehouse)" />

    <div class="sectionTitle">Destinations</div>
    <div id="bizList" class="list"></div>

    <div class="coordBox" id="coordBox">
      <div><b>Admin helper (not for drivers):</b></div>
      <div>Tap the map to show image coordinates for placing arrival points & routes.</div>
      <div id="coordReadout" style="margin-top:6px;">Click the map…</div>
      <div class="smallNote" style="margin-top:6px;">
        Coordinates are in <b>image space</b> (not GPS). This avoids dependency on incorrect public road data.
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
/**
 * ============================================================
 * 1) CONFIG: Set the base image file name here
 * ============================================================
 */
const BASE_IMAGE = "site.png"; // change to "site.jpg" if needed

/**
 * ============================================================
 * 2) DATA: Businesses (Vacant L excluded)
 *    NOTE: A2 is the ONLY visible stop for now (per your request).
 * ============================================================
 *
 * Coordinates are [y, x] in image space (CRS.Simple).
 * Get coords by clicking the map; read [y, x] from the Admin helper box.
 */
const SITE = {
  origin: {
    id: "STAR",
    label: "YOU ARE HERE (Main Entrance / QR)",
    address: "9329 Bonner Mill Road",
    coord: null // TODO later
  },

  businesses: [
    { id:"A", name:"UFP", address:"9088A Bonner Mill Road",
      arrivals: [
        { id:"A1", label:"Arrival A1 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A2", label:"Arrival A2 (Ship/Recv)", visible:true,  coord:null, route: [] },
        { id:"A3", label:"Arrival A3 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A4", label:"Arrival A4 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A5", label:"Arrival A5 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A6", label:"Arrival A6 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A7", label:"Arrival A7 (Ship/Recv)", visible:false, coord:null, route: [] },
        { id:"A8", label:"Arrival A8 (Ship/Recv)", visible:false, coord:null, route: [] },
      ]
    },
    { id:"B", name:"Alcom LLC", address:"9063 Bonner Mill Road",
      arrivals: [
        { id:"B1", label:"Shipping (B1)", coord:null, route: [] },
        { id:"B2", label:"Receiving (B2)", coord:null, route: [] },
      ]
    },
    { id:"C", name:"Montana Whiskey", address:"9257 Bonner Mill Road",
      arrivals: [
        { id:"C1", label:"Arrival (C1)", coord:null, route: [] },
      ]
    },
    { id:"D", name:"Big Sky Fulfillment", address:"9263 Bonner Mill Road",
      arrivals: [
        { id:"D1", label:"Shipping (D1)", coord:null, route: [] },
        { id:"D2", label:"Receiving (D2)", coord:null, route: [] },
        { id:"D3", label:"Shipping/Receiving (D3)", coord:null, route: [] },
      ]
    },
    { id:"E", name:"Posh Chocolate", address:"327 Whitehouse Lane",
      arrivals: [
        { id:"E1", label:"Arrival (E1)", coord:null, route: [] },
      ]
    },
    { id:"F", name:"Zombie Tools", address:"9165 Bonner Mill Road",
      arrivals: [
        { id:"F1", label:"Arrival (F1)", coord:null, route: [] },
      ]
    },
    { id:"G", name:"Botanie Soap", address:"8758 Bonner Mill Road",
      arrivals: [
        { id:"G1", label:"Arrival (G1)", coord:null, route: [] },
      ]
    },
    { id:"H", name:"Northwest Factory Finishes", address:"8941 Bonner Mill Road",
      arrivals: [
        { id:"H1", label:"Arrival (H1)", coord:null, route: [] },
      ]
    },
    { id:"I", name:"Planetary Designs", address:"9255 Bonner Mill Road",
      arrivals: [
        { id:"I1", label:"Arrival (I1)", coord:null, route: [] },
        { id:"I2", label:"Arrival (I2)", coord:null, route: [] },
      ]
    },
    { id:"J", name:"Zootown Volleyball", address:"9251 Bonner Mill Road",
      arrivals: [
        { id:"J1", label:"Arrival (J1)", coord:null, route: [] },
      ]
    },
    { id:"K", name:"WMA Specialist", address:"9088D Bonner Mill Road",
      arrivals: [
        { id:"K1", label:"Arrival (K1)", coord:null, route: [] },
      ]
    },
    { id:"M", name:"WCP Solutions", address:"9088B Bonner Mill Road",
      arrivals: [
        { id:"M1", label:"Arrival (M1)", coord:null, route: [] },
      ]
    },
    { id:"N", name:"NIM Norfolk Iron & Metal", address:"9144 Bonner Mill Road",
      arrivals: [
        { id:"N1", label:"Arrival (N1)", coord:null, route: [] },
      ]
    },
  ]
};

/**
 * ============================================================
 * 3) MAP SETUP: image base map (CRS.Simple)
 * ============================================================
 */
const map = L.map("map", {
  crs: L.CRS.Simple,
  zoomControl: true,
  minZoom: -3,
  maxZoom: 3
});

let imageBounds = null;

const layers = {
  origin: L.layerGroup().addTo(map),
  arrivalMarkers: L.layerGroup().addTo(map),
  route: L.layerGroup().addTo(map),
};

function fmtCoord(latlng) {
  const y = Math.round(latlng.lat);
  const x = Math.round(latlng.lng);
  return `[${y}, ${x}]`;
}

map.on("click", (e) => {
  document.getElementById("coordReadout").innerHTML =
    `Map click coordinate: <code>${fmtCoord(e.latlng)}</code> &nbsp; (y, x)`;
});

function clearSelection() {
  layers.arrivalMarkers.clearLayers();
  layers.route.clearLayers();
}

function resetToEntrance() {
  clearSelection();
  if (SITE.origin.coord && imageBounds) {
    map.setView(SITE.origin.coord, 0);
  } else if (imageBounds) {
    map.fitBounds(imageBounds);
  }
}

document.getElementById("resetBtn").addEventListener("click", resetToEntrance);
document.getElementById("clearBtn").addEventListener("click", clearSelection);

/**
 * ============================================================
 * 4) UI: Inline accordion arrivals under each business
 * ============================================================
 */
let expandedBizId = null;

function visibleArrivalsFor(biz) {
  return biz.arrivals.filter(a => a.visible !== false);
}

function buildBusinessList(filterText = "") {
  const listEl = document.getElementById("bizList");
  listEl.innerHTML = "";

  const q = filterText.trim().toLowerCase();

  const results = SITE.businesses.filter(b => {
    const hay = `${b.id} ${b.name} ${b.address}`.toLowerCase();
    return !q || hay.includes(q);
  });

  results.forEach(b => {
    const vArr = visibleArrivalsFor(b);

    const card = document.createElement("div");
    card.className = "card";
    card.style.cursor = "pointer";
    if (expandedBizId === b.id) card.classList.add("cardActive");

    card.innerHTML = `
      <div class="line1">
        <div>${b.id} – ${b.name}</div>
        <div class="smallNote" style="font-weight:800; color:#555;">${vArr.length} stop${vArr.length!==1 ? "s" : ""}</div>
      </div>
      <div class="line2">${b.address}</div>
      <div class="line3">Tap to show arrival points</div>
    `;

    if (expandedBizId === b.id) {
      const inline = document.createElement("div");
      inline.className = "inlineArrivals";

      if (vArr.length === 0) {
        const note = document.createElement("div");
        note.className = "smallNote";
        note.textContent = "No active arrival points are currently enabled for this business.";
        inline.appendChild(note);
      } else {
        vArr.forEach(a => {
          const btn = document.createElement("button");
          btn.className = "arrivalBtn";
          btn.type = "button";
          btn.innerHTML = `${a.id} – <span>${a.label}</span>`;
          btn.addEventListener("click", (ev) => {
            ev.stopPropagation();
            selectArrival(b.id, a.id);
          });
          inline.appendChild(btn);
        });
      }

      card.appendChild(inline);
    }

    card.addEventListener("click", () => {
      expandedBizId = (expandedBizId === b.id) ? null : b.id;
      buildBusinessList(document.getElementById("search").value);

      // On mobile, expand the drawer automatically when a business is tapped
      if (window.matchMedia("(max-width: 860px)").matches) {
        setDrawerCollapsed(false);
      }
    });

    listEl.appendChild(card);
  });

  if (results.length === 0) {
    const empty = document.createElement("div");
    empty.className = "smallNote";
    empty.textContent = "No matches. Try a different business name or address number.";
    listEl.appendChild(empty);
  }
}

document.getElementById("search").addEventListener("input", (e) => {
  buildBusinessList(e.target.value);
});

function selectArrival(bizId, arrivalId) {
  const biz = SITE.businesses.find(b => b.id === bizId);
  if (!biz) return;
  const ap = biz.arrivals.find(a => a.id === arrivalId);
  if (!ap) return;

  layers.arrivalMarkers.clearLayers();
  layers.route.clearLayers();

  if (!ap.coord || ap.coord.length !== 2) {
    alert(`${arrivalId} has no coordinate yet.\n\nClick the map at the correct spot and copy the [y,x] into index.html for ${arrivalId}.`);
    return;
  }

  const arrivalMarker = L.marker(ap.coord, { title: `${biz.id} ${biz.name} - ${ap.id}` })
    .bindPopup(`<b>${biz.id} – ${biz.name}</b><br>${biz.address}<br><b>${ap.id}</b>: ${ap.label}`)
    .addTo(layers.arrivalMarkers);

  if (Array.isArray(ap.route) && ap.route.length >= 2) {
    L.polyline(ap.route, { weight: 8, opacity: 0.9 })
      .addTo(layers.route);
    const bounds = L.latLngBounds(ap.route);
    map.fitBounds(bounds.pad(0.2));
  } else {
    map.setView(ap.coord, 0);
  }

  arrivalMarker.openPopup();

  // On mobile, collapse drawer after choosing an arrival point to maximize map
  if (window.matchMedia("(max-width: 860px)").matches) {
    setDrawerCollapsed(true);
  }
}

/**
 * ============================================================
 * 5) Mobile drawer behavior: expand/collapse
 * ============================================================
 */
const sidebar = document.getElementById("sidebar");
const drawerBtn = document.getElementById("drawerToggleBtn");

function setDrawerCollapsed(collapsed) {
  if (!window.matchMedia("(max-width: 860px)").matches) return;

  sidebar.classList.toggle("drawer-collapsed", collapsed);
  drawerBtn.textContent = collapsed ? "Expand" : "Collapse";
}

drawerBtn.addEventListener("click", () => {
  const isCollapsed = sidebar.classList.contains("drawer-collapsed");
  setDrawerCollapsed(!isCollapsed);
});

// Start collapsed on mobile so the map is big
function applyInitialDrawerState() {
  if (window.matchMedia("(max-width: 860px)").matches) {
    setDrawerCollapsed(true);
  } else {
    sidebar.classList.remove("drawer-collapsed");
  }
}
window.addEventListener("resize", applyInitialDrawerState);

/**
 * ============================================================
 * 6) Load base image and init
 * ============================================================
 */
function initWithImage() {
  // Build list immediately (even if the image fails)
  buildBusinessList("");

  const img = new Image();
  img.onload = () => {
    const w = img.width;
    const h = img.height;

    imageBounds = [[0,0],[h,w]];
    L.imageOverlay(BASE_IMAGE, imageBounds).addTo(map);
    map.fitBounds(imageBounds);

    // Origin marker once you set SITE.origin.coord
    layers.origin.clearLayers();
    if (SITE.origin.coord) {
      L.circleMarker(SITE.origin.coord, { radius: 10, weight: 2 })
        .bindPopup(`<b>${SITE.origin.label}</b><br>${SITE.origin.address}`)
        .addTo(layers.origin);
    }
  };
  img.onerror = () => {
    alert(`Could not load base image "${BASE_IMAGE}".\n\nMake sure it is in the same folder as index.html in your GitHub repo.`);
  };
  img.src = BASE_IMAGE;

  applyInitialDrawerState();
}

initWithImage();
</script>
</body>
</html>
